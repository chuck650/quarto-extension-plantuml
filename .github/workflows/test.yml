name: Test Extension
on:
  push:
    paths:
      - '_extensions/**'
  pull_request:
    paths:
      - '_extensions/**'
  workflow_dispatch:

jobs:
  test-render:
    runs-on: ubuntu-latest
    
    # Define Quarto and PlantUML versions here for easy updates
    env:
      QUARTO_VERSION: 1.8.25
      PLANTUML_VERSION: 1.2025.10

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      # 1. Install Dependencies (Java, Graphviz, Wget)
      - name: Install Core Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y graphviz openjdk-17-jre-headless wget unzip

      # 2. Manual Quarto Installation
      - name: Install Quarto Manually via Wget
        run: |
          # Use safe curly braces for robustness
          QUARTO_URL="https://github.com/quarto-dev/quarto-cli/releases/download/v${QUARTO_VERSION}/quarto-${QUARTO_VERSION}-linux-amd64.deb"
          wget "$QUARTO_URL" -O quarto.deb
          sudo dpkg -i quarto.deb
          sudo apt-get install -f -y 

      # 3. DOWNLOAD PLANTUML JAR AND CREATE SHELL WRAPPER
      # This guarantees the 'plantuml' executable is on the $PATH for your Lua extension.
      - name: Download PlantUML JAR and create executable wrapper
        run: |
          PLANTUML_DIR="/usr/local/share/plantuml"
          PLANTUML_JAR="plantuml.jar"
          # CLEAN URL: No Markdown pollution, using safe curly braces.
          PLANTUML_URL="https://github.com/plantuml/plantuml/releases/download/v${PLANTUML_VERSION}/plantuml-${PLANTUML_VERSION}.jar"
          
          # --- Installation ---
          sudo mkdir -p $PLANTUML_DIR
          sudo wget -O $PLANTUML_DIR/$PLANTUML_JAR "$PLANTUML_URL"
          
          # 1. Create wrapper script at /usr/local/bin/plantuml
          WRAPPER_PATH="/usr/local/bin/plantuml"
          echo '#!/bin/sh' | sudo tee $WRAPPER_PATH > /dev/null
          # Note: Must use /usr/local/share/plantuml/plantuml.jar for the path
          echo "java -jar $PLANTUML_DIR/$PLANTUML_JAR \"\$@\"" | sudo tee -a $WRAPPER_PATH > /dev/null
          sudo chmod +x $WRAPPER_PATH
          
          # --- Verification ---
          echo "--- Verifying PlantUML Executable ---"
          echo "PATH: $PATH"
          if ! which plantuml; then
              echo "Error: 'plantuml' command not found via 'which'. Lua lookup will fail."
              exit 1
          fi
          plantuml -version
          echo "Verification successful."

      # 4. Render Document AND Check Artifact Integrity
      - name: Render document and verify artifacts
        run: |
          HTML_FILE="example.html"

          quarto render

          # --- Integrity Check ---
          if [ ! -f "$HTML_FILE" ]; then
              echo "Error: Required artifact $HTML_FILE was NOT created."
              exit 1
          fi

          if ls *.svg 1> /dev/null 2>&1; then
              echo "SUCCESS: Found generated SVG artifact."
          else
              echo "Error: Generated PlantUML asset (*.svg) was NOT created. PlantUML failed to execute."
              exit 1
          fi

      # 5. Upload Artifacts
      - name: Upload rendered artifacts
        uses: actions/upload-artifact@v4
        with:
          name: quarto-rendered-output
          path: |
            _site
            *.html
            *.svg