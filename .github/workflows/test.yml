name: Test Extension
on:
  push:
    paths:
      - '_extensions/**'
  pull_request:
    paths:
      - '_extensions/**'
  workflow_dispatch:

jobs:
  test-render:
    runs-on: ubuntu-latest
    
    # Define Quarto and PlantUML versions here for easy updates
    env:
      QUARTO_VERSION: 1.8.25
      PLANTUML_VERSION: 1.2025.10

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      # 1. Install Dependencies (Java, Graphviz, Wget)
      # Uses the command line equivalent of our successful APT installs.
      - name: Install Core Dependencies
        run: |
          sudo apt-get update
          # Install Graphviz and a minimal JRE for PlantUML
          sudo apt-get install -y graphviz openjdk-17-jre-headless wget unzip

      # 2. Manual Quarto Installation (Skipping the broken action)
      # Downloads the official Debian package and installs it directly.
      - name: Install Quarto Manually via Wget
        run: |
          QUARTO_URL="https://github.com/quarto-dev/quarto-cli/releases/download/v${QUARTO_VERSION}/quarto-${QUARTO_VERSION}-linux-amd64.deb"
          wget "$QUARTO_URL" -O quarto.deb
          sudo dpkg -i quarto.deb
          sudo apt-get install -f -y # Fix dependencies

      # 3. DOWNLOAD AND CONFIGURE PLANTUML
      # Downloads the JAR and uses an environment variable to tell Quarto where to find it.
      - name: Download PlantUML JAR and set environment
        run: |
          PLANTUML_DIR="${{ runner.temp }}/plantuml"
          mkdir -p $PLANTUML_DIR
          
          PLANTUML_JAR_URL="https://github.com/plantuml/plantuml/releases/download/v${PLANTUML_VERSION}/plantuml-${PLANTUML_VERSION}.jar"
          echo "PlantUML JAR URL: $PLANTUML_JAR_URL"
          wget -O $PLANTUML_DIR/plantuml.jar "$PLANTUML_JAR_URL"
          
          # Tell Quarto where the JAR is located. This is the official documented way.
          echo "QUARTO_PLANTUML_PATH=$PLANTUML_DIR/plantuml.jar" >> $GITHUB_ENV

      # 4. Render Document
      - name: Render document
        run: quarto render
        
      # 5. Upload Artifacts
      - name: Upload rendered artifacts
        uses: actions/upload-artifact@v4
        with:
          name: quarto-rendered-output
          path: |
            _site
            *.html
            *.svg
