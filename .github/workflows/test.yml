name: Test Extension
on:
  push:
    paths:
      - '_extensions/**'
  pull_request:
    paths:
      - '_extensions/**'
  workflow_dispatch:

jobs:
  test-render:
    runs-on: ubuntu-latest
    
    # Define Quarto and PlantUML versions here for easy updates
    env:
      QUARTO_VERSION: 1.8.25
      PLANTUML_VERSION: 1.2025.10

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      # 1. Install Dependencies (Java, Graphviz, Wget)
      - name: Install Core Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y graphviz openjdk-17-jre-headless wget unzip

      # 2. Manual Quarto Installation
      - name: Install Quarto Manually via Wget
        run: |
          QUARTO_URL="https://github.com/quarto-dev/quarto-cli/releases/download/v${QUARTO_VERSION}/quarto-${QUARTO_VERSION}-linux-amd64.deb"
          wget "$QUARTO_URL" -O quarto.deb
          sudo dpkg -i quarto.deb
          sudo apt-get install -f -y

      # 3. DOWNLOAD PLANTUML JAR (Preparing the path)
      - name: Download PlantUML JAR and prepare path
        id: plantuml_path_prep # Assign an ID to this step
        run: |
          PLANTUML_DIR="${{ runner.temp }}/plantuml"
          mkdir -p $PLANTUML_DIR
          PLANTUML_JAR_URL="https://github.com/plantuml/plantuml/releases/download/v${PLANTUML_VERSION}/plantuml-${PLANTUML_VERSION}.jar"
          
          # Download the JAR
          wget -O $PLANTUML_DIR/plantuml.jar "$PLANTUML_JAR_URL"
          
          # Use set-output to make the full path available to the next step
          echo "plantuml_jar_path=$PLANTUML_DIR/plantuml.jar" >> "$GITHUB_OUTPUT"

      # 4. Render Document (FIX: Setting QUARTO_PLANTUML_PATH explicitly in the environment)
      - name: Render document
        env:
          # Set the environment variable using the output from the previous step
          QUARTO_PLANTUML_PATH: ${{ steps.plantuml_path_prep.outputs.plantuml_jar_path }}
        run: quarto render

      # 5. Upload Artifacts
      - name: Upload rendered artifacts
        uses: actions/upload-artifact@v4
        with:
          name: quarto-rendered-output
          path: |
            _site
            *.html
            *.svg